-- Mode 7 shader.
-- Shows a texture in a perspective view and adds a curvature effect.
-- Inspired from https://www.shadertoy.com/view/ltsGWn

shader{

    vertex_source = [[

    #version 120

    void main() {

//      gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;
      gl_Position = gl_ModelViewMatrix * gl_Vertex;
      gl_TexCoord[0] = gl_MultiTexCoord0;
    }
]],

    fragment_source = [[

    #version 120

    #define TEXEL(x,y) texture2D(x,y)

    uniform sampler2D solarus_sampler;
    uniform vec2 solarus_input_size;
    uniform vec2 solarus_output_size;
    vec2 solarus_texture_size = solarus_input_size;
    uniform int solarus_time;

    vec2 resolution = solarus_output_size;

    // Tweak this parameter for more / less distortion
    #define distortion 1.2

    vec2 radialDistortion(vec2 coord) {
      coord *= solarus_texture_size / solarus_input_size;
      vec2 cc = coord - vec2(0.5);
      float dist = dot(cc, cc) * distortion;
      return (coord + cc * (1.0 + dist) * dist) * solarus_input_size / solarus_texture_size;
    }

    vec4 mainImage(vec2 fragCoord) {

      vec2 q = fragCoord / resolution;
      q = radialDistortion(q);
      vec2 uv = q - vec2(0.5);

      // Create a 3D point
   //   float h = 0.25;
      float h = 0.25;
      vec3 p = vec3(uv.x, uv.y - h - 1.0, uv.y - h);

      // Projecting back to 2D space
      vec2 uvm7 = p.xy / p.z;

      // Texture scaling if you need
  //    float scale = 0.4;
      float scale = 0.05;
      uvm7 *= scale;

      // Rotations if needed
      float a = (solarus_time / 1000.0) * 0.5;
//      float a = 0.0;
      mat2 rotation = mat2(cos(a), - sin(a), sin(a), cos(a));
      uvm7 *= rotation;

      // Repeat
    //  uvm7 = fract(uvm7);  // Unnecessary if GL_REPEAT is set on the texture.

      // Read background texture
      vec3 col = TEXEL(solarus_sampler, uvm7).xyz;

      // Darkness based on the horizon
      col *= abs(uv.y - h - 0.35);

      // Output the color
      return vec4(col, 1.0);
  }

    void main() {
      gl_FragColor = mainImage(gl_FragCoord.xy);
//      gl_FragColor = mainImage(gl_TexCoord[0].xy);
    }
    ]]
}
